<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Explorers Scavenger Hunt</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: Arial,sans-serif; background:#121212; color:#eee; display:flex; align-items:center; justify-content:center; min-height:100vh; }
  .card { background:#1f1f1f; padding:20px; border-radius:12px; width:480px; box-shadow:0 6px 20px rgba(0,0,0,.5); }
  input, select, button { display:block; width:100%; padding:10px; margin:8px 0; border-radius:6px; border:none; }
  button { background:#2e8b57; color:white; cursor:pointer; font-weight:600; }
  .progress-log { max-height:150px; overflow:auto; font-size:0.9rem; text-align:left; background:#111; padding:10px; border-radius:6px; }
  .team-banner { font-size:1.05rem; margin-bottom:8px; color:#2e8b57; font-weight:bold; }
  #feedback.correct { color:#4caf50; } 
  #feedback.incorrect { color:#f44336; }
</style>
</head>
<body>

<div class="card" id="loginScreen">
  <h2>Team Login</h2>
  <input id="teamName" placeholder="Team name (unique)" />
  <select id="courseSelect">
    <option value="">Select starting position</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="D">D</option>
  </select>
  <button id="startBtn">Start Game</button>
  <button id="resetBtn" style="background:#b22222;">Reset Team Progress</button>
  <p class="small">Good luck!!</p>
</div>

<div class="card" id="gameScreen" style="display:none;">
  <div class="team-banner" id="teamBanner"></div>
  <h2 id="locationTitle">Location</h2>
  <p id="questionText"></p>
  <input id="answerInput" placeholder="Your answer" />
  <button id="submitBtn">Submit</button>
  <div id="feedback"></div>
  <div style="margin-top:12px;">
    <div class="small">Progress log:</div>
    <div id="progressLog" class="progress-log"></div>
  </div>
</div>

<script>
// ----------------- CONFIG: Replace with your Google Form info -----------------
const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSePVjz661Snvw37RbIWzl4cNqFZvlL2aP1oFlIscEsMyiq-Sg/formResponse';
const FIELD_TEAM   = 'entry.790722666';
const FIELD_LOCATION  = 'entry.1479422454';
const FIELD_TIME = 'entry.1701992017';
// ------------------------------------------------------------------------------

let questions = [];
const startingPoints = { A:1, B:4, C:7, D:10 }; // zero-based start index
let teams = {};
if(localStorage.getItem('teamsData')){
  try { teams = JSON.parse(localStorage.getItem('teamsData')); } catch(e){ teams={}; }
}
let currentTeam = null;

const loginScreen = document.getElementById('loginScreen');
const gameScreen = document.getElementById('gameScreen');
const teamBanner = document.getElementById('teamBanner');
const teamNameInput = document.getElementById('teamName');
const courseSelect = document.getElementById('courseSelect');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const answerInput = document.getElementById('answerInput');
const submitBtn = document.getElementById('submitBtn');
const progressLogEl = document.getElementById('progressLog');
const locationTitle = document.getElementById('locationTitle');
const questionText = document.getElementById('questionText');
const feedbackEl = document.getElementById('feedback');

function saveTeams(){ localStorage.setItem('teamsData', JSON.stringify(teams)); }

// --- Load questions from JSON ---
fetch('questions.json')
  .then(res => res.json())
  .then(data => { questions = data; })
  .catch(err => alert('Failed to load questions.json: '+err));

// --- Start game ---
startBtn.addEventListener('click', () => {
  if(!questions.length) return alert("Questions not loaded yet.");
  const name = teamNameInput.value.trim();
  const course = courseSelect.value;
  if(!name || !course) return alert('Enter team name and choose course');

  currentTeam = name;
  if(!teams[name]){
    const startIdx = startingPoints[course];
    teams[name] = { course, startIndex:startIdx, index:0, log:[], finished:false };
    saveTeams();
  }
  teamBanner.textContent = `Team: ${currentTeam} (${teams[name].course})`;
  loginScreen.style.display='none';
  gameScreen.style.display='block';
  showQuestion();
  updateProgressLogUI();
});

// --- Reset progress ---
resetBtn.addEventListener('click', ()=>{
  const name = teamNameInput.value.trim();
  if(!name) return alert('Enter team name to reset');
  if(teams[name]){
    if(!confirm(`Reset progress for team "${name}"?`)) return;
    delete teams[name];
    saveTeams();
    alert(`Progress for "${name}" reset.`);
  } else alert(`No saved progress for "${name}"`);
});

// --- Calculate question index with looping ---
function getQuestionIndex(team){
  return (team.startIndex + team.index) % questions.length;
}

// --- Show question ---
function showQuestion(){
  const t = teams[currentTeam];
  if(t.finished || t.index >= questions.length){
    locationTitle.textContent = "🎉 Finished!";
    questionText.textContent = "";
    answerInput.style.display='none';
    submitBtn.style.display='none';
    feedbackEl.className='';
    feedbackEl.textContent = `🎉 Congrats, ${currentTeam}! You completed all locations, now go back to Clifford's Tower! `;
    return;
  }
  const qIdx = getQuestionIndex(t);
  const q = questions[qIdx];
  locationTitle.textContent = `${q.location} (Location ${t.index+1})`;
  questionText.textContent = q.question;
  answerInput.value='';
  feedbackEl.textContent='';
  feedbackEl.className='';
  answerInput.style.display='block';
  submitBtn.style.display='block';
}

// --- Submit answer ---
submitBtn.addEventListener('click', () => {
  const t = teams[currentTeam];
  if(!t || t.finished) return;
  const qIdx = getQuestionIndex(t);
  const q = questions[qIdx];
  const ans = answerInput.value.trim().toLowerCase();
  if(!ans) return;

  if(ans === q.answer.toLowerCase()){
    const ts = new Date().toLocaleTimeString();
    t.log.push(`✔ ${q.location} solved at ${ts}`);
    t.index++;
    if(t.index >= questions.length) t.finished = true;
    saveTeams();

    feedbackEl.textContent = "✅ Correct!";
    feedbackEl.className = "correct";
    showQuestion();
    updateProgressLogUI();

    // --- Send correct answer to Google Form ---
    const fd = new FormData();
    fd.append(FIELD_TEAM, currentTeam);
    fd.append(FIELD_LOCATION, q.name);
    fd.append(FIELD_TIME, ts);
    fetch(FORM_URL, { method:'POST', body:fd }).catch(err=>console.warn("Logging error:", err));

  } else {
    feedbackEl.textContent = "❌ Incorrect, try again.";
    feedbackEl.className = "incorrect";
  }
});

// --- Update progress log UI ---
function updateProgressLogUI(){
  const t = teams[currentTeam];
  progressLogEl.innerHTML = t.log.slice().reverse().map(a=>`<div>${a}</div>`).join('');
}
</script>
</body>
</html>
